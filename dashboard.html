<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Federal Reserved Accounts – Dashboard</title>
  <meta name="description" content="User Dashboard — Federal Reserved Accounts" />
  <link rel="stylesheet" href="dashboard.css">
  <link rel="icon" href="images/fra-logo.png" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body>
  <!-- Sidebar -->
  <aside class="f-sidebar">
    <div class="logo-row mb-6">
      <img src="images/fra-logo.png" alt="FRA logo" />
      <div>
        <div class="brand-title">Federal Reserved Accounts</div>
        <div class="brand-sub">Secure banking platform</div>
        <div class="trustline">Backed by the U.S. Treasury Department</div>
      </div>
    </div>

    <nav>
      <div id="nav-dashboard" class="nav-item active" data-target="section-dashboard">Dashboard Overview</div>
      <div id="nav-assets" class="nav-item" data-target="section-assets">Secure Asset Management</div>

      <hr class="my-4 border-white/10">

      <div id="openRequestDebit" class="nav-item">Request Secure Card</div>
      <div id="openRequestCheck" class="nav-item">Request Checkbook</div>
      <div id="openChangePassword" class="nav-item">Change Password</div>
      <div id="openContact" class="nav-item">Dedicated Support</div>
    </nav>

    <div class="sidebar-footer">
      <button id="logoutBtnSidebar" class="btn-ghost">Logout Securely</button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">
    <header class="top">
      <div>
        <div class="pf-welcome-small">Welcome back</div>
        <!-- pf-welcome is populated by JS with the user's name only -->
        <h1 id="pf-welcome">—</h1>
        <div class="badge">Member — Federal Reserved Network</div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <button id="addMoneyBtn" class="btn-primary">Initiate Deposit</button>
        </div>
        <div class="txt-small muted">Last login: <span id="lastLogin">—</span></div>
      </div>
    </header>

    <!-- Summary -->
    <div class="summary-row">
      <div class="summary-card">
        <div class="summary-label">Total Balance</div>
        <div id="totalBalance" class="summary-value">$0.00</div>
        <div class="txt-small muted">Accounts: <span id="accountCount">0</span></div>
      </div>

      <div class="summary-card">
        <div class="summary-label">Recent Activity</div>
        <div class="txt-small muted">No recent transactions</div>
        <div style="margin-top:10px"><button class="btn-ghost">View activity</button></div>
      </div>

      <div class="summary-card">
        <div class="summary-label">Security</div>
        <div class="txt-small muted">2-factor authentication recommended</div>
        <div style="margin-top:10px"><button class="btn-ghost">Security settings</button></div>
      </div>
    </div>

    <!-- Accounts -->
    <section id="section-dashboard" class="mb-6">
      <h2 class="text-xl font-semibold mb-4">Accounts</h2>
      <div id="accountCards" class="accounts-grid"></div>
    </section>

    <!-- Secure Assets -->
    <section id="section-assets" class="hidden">
      <h2 class="text-xl font-semibold mb-4">Secure Asset Management</h2>
      <p class="muted txt-small">Manage secure cards, checkbooks, and deposit instructions.</p>
      <div style="margin-top:12px">
        <button class="btn-primary mr-2" onclick="openStaticModal('safeguardModal')">View Safeguard Methods</button>
        <button class="btn-ghost" onclick="openStaticModal('safeguardEditorModal')">Edit Methods (Admin)</button>
      </div>
    </section>
  </main>

  <!-- Static Modals (unchanged structure) -->
  <div id="requestDebitModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <h3>Request Secure Card</h3>
      <p class="muted txt-small">Enter delivery address for your secure card. We will notify you once the card ships.</p>
      <form id="debitCardForm">
        <label class="txt-small">Delivery address</label>
        <textarea id="debitAddress" class="editor-area" required></textarea>
        <div class="btn-row">
          <button type="submit" class="btn-primary">Submit</button>
          <button type="button" class="btn-ghost" data-close="requestDebitModal">Cancel</button>
        </div>
        <p id="debitResult" class="txt-small muted" style="display:none;margin-top:10px"></p>
      </form>
    </div>
  </div>

  <div id="requestCheckModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <h3>Request Checkbook</h3>
      <p class="muted txt-small">Enter delivery address for your checkbook. We will dispatch once confirmed.</p>
      <form id="checkbookForm">
        <label class="txt-small">Delivery address</label>
        <textarea id="checkbookAddress" class="editor-area" required></textarea>
        <div class="btn-row">
          <button type="submit" class="btn-primary">Submit</button>
          <button type="button" class="btn-ghost" data-close="requestCheckModal">Cancel</button>
        </div>
        <p id="checkbookResult" class="txt-small muted" style="display:none;margin-top:10px"></p>
      </form>
    </div>
  </div>

  <div id="changePasswordModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <h3>Change Password</h3>
      <p class="muted txt-small">Change your password. For demo mode this will show a confirmation only.</p>
      <form id="passwordForm">
        <label class="txt-small">Current Password</label>
        <input type="password" class="editor-area" required />
        <label class="txt-small">New Password</label>
        <input type="password" class="editor-area" required />
        <label class="txt-small">Confirm Password</label>
        <input type="password" class="editor-area" required />
        <div class="btn-row">
          <button type="submit" class="btn-primary">Apply</button>
          <button type="button" class="btn-ghost" data-close="changePasswordModal">Cancel</button>
        </div>
        <p id="passwordResult" class="txt-small muted" style="display:none;margin-top:10px"></p>
      </form>
    </div>
  </div>

  <div id="safeguardModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <h3>Safeguard Methods</h3>
      <p class="muted txt-small">Choose a deposit method and accept the NDA to view instructions.</p>
      <div id="safeguardBody" class="mt-3"></div>
      <div class="btn-row"><button class="btn-ghost" data-close="safeguardModal">Close</button></div>
    </div>
  </div>

  <div id="supportModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <h3>Dedicated Support</h3>
      <p class="muted txt-small">Call our dedicated support line or visit our support portal.</p>
      <p class="text-2xl font-bold mt-3">+1 (380) 225-0409</p>
      <p class="txt-small muted mt-2">Federal Reserved Accounts — Washington, D.C., USA</p>
      <div class="btn-row"><button class="btn-ghost" data-close="supportModal">Close</button></div>
    </div>
  </div>

  <div id="safeguardEditorModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <h3>Safeguard Instructions Editor</h3>
      <p class="muted txt-small">Admin-only editor for deposit instructions (HTML allowed).</p>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
        <div><label class="txt-small">Method</label>
          <select id="editorMethod" class="editor-area" style="height:44px">
            <option value="wire_transfer">Wire Transfer</option>
            <option value="crypto">Digital Asset (Crypto)</option>
            <option value="gold">Physical Asset (Gold)</option>
            <option value="cash">Certified Cash</option>
          </select>
        </div>
        <div><label class="txt-small">Title</label><input id="editorTitle" class="editor-area" style="height:44px" /></div>
        <div style="grid-column:1/-1"><label class="txt-small">Details (HTML allowed)</label><textarea id="editorDetails" class="editor-area"></textarea></div>
        <div style="grid-column:1/-1;display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
          <button id="saveInstructionBtn" class="btn-primary">Save</button>
          <button type="button" class="btn-ghost" data-close="safeguardEditorModal">Close</button>
        </div>
      </div>
      <p id="editorStatus" class="txt-small muted" style="display:none;margin-top:10px"></p>
    </div>
  </div>

  <!-- Keep your Supabase script and embedded JS exactly as before -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>

  <!-- your existing embedded JS (unchanged) -->
  <script>
    /* Paste your exact embedded JS here (the one you provided) OR keep it external as dashboard.js.
       I intentionally did not alter the logic that fetches profile / accounts / deposit flows etc. */
  </script>

  <!-- existing external dashboard.js (if you use it) -->
  <script src="dashboard.js" defer></script>

  <!-- ===== small safety UI script (non-functional logic) =====
       - ensures modal panels get a visible top-right close btn
       - wires the top-right Initiate Deposit button to openInitiateDeposit() like account cards
       This does not change any Supabase behavior or account logic.
  -->
  <script>
    // Add a visible close (x) button to each static modal-panel so user can always close easily
    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.modal .modal-panel').forEach(panel => {
        // only add once
        if (panel.querySelector('.modal-close')) return;
        const btn = document.createElement('button');
        btn.className = 'modal-close';
        btn.type = 'button';
        btn.innerHTML = '✕';
        btn.title = 'Close';
        btn.addEventListener('click', function(){ 
          const modal = panel.closest('.modal'); 
          if (modal) modal.setAttribute('aria-hidden','true'); 
        });
        panel.appendChild(btn);
      });

      // ensure the top-right Initiate Deposit works exactly like account card buttons
      const topBtn = document.getElementById('addMoneyBtn');
      if (topBtn) {
        topBtn.addEventListener('click', function(e){
          e.preventDefault();
          // call the same function that account buttons call — pass null so it opens the selector
          if (typeof openInitiateDeposit === 'function') openInitiateDeposit(null);
        });
      }
    });

    // Also ensure any dynamically-created modal's close-icons are clickable (when createModal is used)
    const origCreate = window.createModal;
    if (typeof origCreate === 'function') {
      window.createModal = function(innerHTML) {
        const modal = origCreate(innerHTML);
        // small delay to ensure panel exists
        setTimeout(() => {
          const panel = modal.querySelector('.modal-panel');
          if (panel && !panel.querySelector('.modal-close')) {
            const btn = document.createElement('button');
            btn.className = 'modal-close';
            btn.type = 'button';
            btn.innerHTML = '✕';
            btn.title = 'Close';
            btn.addEventListener('click', () => modal.remove());
            panel.appendChild(btn);
          }
        }, 10);
        return modal;
      };
    }
  </script>
</body>
</html>
